# zod-factory
Zod Factory introduces Typescript compiler API factory abstractions for creating zod validation schemas.

### ⚠️ In Progress ⚠️
This library is still in very early stages and is not fully featured yet with the `zod` itself. I hope to continue adding more features and abstractions to the library to make it on par with `zod` and some more utilities.

# Motivation
The Typescript Compiler API is very powerful, and heavily featured to handle a variety of use cases, but it can also be overwhelming to work with directly. 

For example, consider the zod schema below, and the corresponding Typescript compiler factory API code to generate the AST representation of this schema.

**zod Schema**
```typescript
const person = z.object({
  name: z.string(),
  age: z.number(),
});
```

**Typescript Compiler factory API definition**
<details>
<summary>Expand for TS Compiler API factory Definition</summary>
  
  ```typescript
  factory.createVariableStatement(
    undefined,
    factory.createVariableDeclarationList(
      [factory.createVariableDeclaration(
        factory.createIdentifier("person"),
        undefined,
        undefined,
        factory.createCallExpression(
          factory.createPropertyAccessExpression(
            factory.createIdentifier("z"),
            factory.createIdentifier("object")
          ),
          undefined,
          [factory.createObjectLiteralExpression(
            [
              factory.createPropertyAssignment(
                factory.createIdentifier("name"),
                factory.createCallExpression(
                  factory.createPropertyAccessExpression(
                    factory.createIdentifier("z"),
                    factory.createIdentifier("string")
                  ),
                  undefined,
                  []
                )
              ),
              factory.createPropertyAssignment(
                factory.createIdentifier("age"),
                factory.createCallExpression(
                  factory.createPropertyAccessExpression(
                    factory.createIdentifier("z"),
                    factory.createIdentifier("number")
                  ),
                  undefined,
                  []
                )
              )
            ],
            true
          )]
        )
      )],
      ts.NodeFlags.Const
    )
  )
  ```
</details>
<br/>

A big disadvantage of this pattern is that it is not as semantic as the zod schema itself, and is not easily extensible, modifiable or script-able. 

This project introduces some abstractions on top of the TS compiler API specifically for the purpose of generating AST nodes for zod schemas. 

Here, the above zod expression can be generated using this library in a number of different ways, as described in the [API](#api) section below.


# Features

## API
The AST node for the zod schema above can be created using this library in 3 different ways:

### `zf` - zod-factory main
This exposes helper methods for generating the corresponding AST nodes that map to a zod schema. 

```typescript
zf.object({
  name: zf.string(),
  age: zf.numberMethods.min(zf.number(), 18),
});
```

Here, methods that can be accessed directly on the `zod` object can also be accessed directly on the `zf` object to generate their AST node equivalent.

Methods that are accessed not-directly on zod (e.g `min`, `max`, `email` etc.) are accessibly on an `xyzMethods` key, where `xyz` is the name of the zod property they are accessible on. This could be subject to change if there is a better experience for this.

### `zfs` - zod-factory 'serialized'
This API builds on top of the core, and accepts more 'serial' arguments:
```typescript
zfs([
  ['object', {
    name: zfs([['string']]),
    age: zfs([['number'], ['max', 10]]),
  }]
])
```
The format for the arguments here is a list of lists, where each item in the outer list is of the shape: `['method', ...args]`.

### `zfl` - zod-factory 'lazy'
And then finally, an API which has an API closest to zod itself, and executes 'lazily'. Under the hood, all arguments necessary to create the AST are accumulated until a call to `create` is made:
```typescript
zfl().object({
  name: zfl().string().create(),
  age: zfl().number().min(18).create(),
}).create()
```
This particular API is mostly for convenience, to make it feel more like zod itself.

# Applications
This project has applications primarily in code generation. In the `playground` directory, I experiment with some code generation tasks, including directly from expressions generated by `zf`, `zfs` and `zfl` above, and then also from an experimental "custom-format". See more below.

## Codegen from TS Zod Factory AST Nodes
Inside the playground, there is a `codegen.ts` script which takes a list of `filename:schemaNameRegex` arguments, and generates zod schemas from the schema AST node definitions in the file that match the regex.

To run the `playground` codegen script on the `main.ts` file in the same directory for example, run:
```bash
$ cd playground
$ ts-node codegen.ts 'main:expression.*'
```

## Codegen from Custom Validation Rules Format
This "custom-format" is a basic format I came up with for defining validation rules that can be translated to zod. It is not fully featured, but is a POC for code generation from other validation rule definition formats to work on in the future (such as OpenAPI schemas, and Google's Protobufs)! 

One interesting feature from OpenAPI it explores for the moment is named references to other schemas defined in the file, to allow using predefined schema within zod `object`'s and `array`'s for example.

To run playground codegen script on some custom-format definitions, run:
```bash
$ cd playground
$ ts-node codegen-custom.ts 'custom-format:.*'
```

# Acknowledgements
This library was birthed from an independent study course project I am undertaking with my advisor, professor Garret Morris at the University of Iowa.




